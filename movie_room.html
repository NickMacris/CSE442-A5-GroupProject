<!DOCTYPE html>
<html lang="en">
 <head>
   <meta charset="UTF-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <meta http-equiv="X-UA-Compatible" content="ie=edge" />
   <title>Movie</title>
   <link rel="stylesheet" type ="text/css" href="movie_room.css">
 </head>

    <body>
  <!-- Voting Action-->
  <div class="voting_booth" >
    <p id = "Vote_Message">Vote here</p>
    <pid id = "voting_booth"></pid>
    <img id = "movie_img" src="#" alt="Movie Description">
    <p id = "movie_name"></p>
    <p id = "movie_year"></p>
    <p id = "movie_genre"></p>
    <button id = "yes_button" onclick = "vote_yes()"class="voting_buttons vote_yes">Yes</button>
    <button id = "no_button" onclick = "vote_no()"class="voting_buttons vote_no">No</button>
</div>

<!-- Chatting Action-->
<div class=chat>
    <div class="chat_booth" >
        <pid id = "chat_history"> </pid>
        <p>Chat here</p>
        
    </div>

    <div class="chat_box">
        <input type = "text" id="input_chat" name="input_chat" placeholder="Send a message" >
        <button id="send_chat" onclick = "send_chat()" class="btn btn-primary btn-md"> Send! </button> 
    </div>
</div>

<!-- Buttons -->
<div class = page_navigation>
    <a  href="https://cse442.com">
        <button class="sign_out"> SIGN OUT</button>
    </a>
    <a href="https://cse442.herokuapp.com/Homepage">
        <button class="home"> Home</button>
    </a>
    <a href="https://cse442.herokuapp.com/find_friends">
        <button class="find_friend"> Find Friend</button>
    </a>
    <a href="https://cse442.herokuapp.com/mainpage/creatingroom/createRoom.html">
        <button class="create_room"> Create Room</button>

    </a>
    <a href="">
        <button class="join_room"> Join Room</button>
    </a>               <button class="profile"> Profile</button>
    <a href="">
        <button class="help"> Help</button>    

    </a>    
</div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        
        // select relevant elements
        var chat = document.getElementById("input_chat");
        var chat_history = document.getElementById('chat_history');
        var booth = document.getElementById('voting_booth');
        var movie_img_url = document.getElementById("movie_img");
        var movie_name = document.getElementById("movie_name");
        var movie_year = document.getElementById("movie_year");
        var movie_genre = document.getElementById("movie_genre");
        var vote_message = document.getElementById("Vote_Message");
        //reset movie_page
        function reset(){
            //set vote table
            movie_img_url.src = "https://upload.wikimedia.org/wikipedia/commons/thumb/4/46/Question_mark_%28black%29.svg/200px-Question_mark_%28black%29.svg.png";
            movie_year.innerHTML = "Coolest Year";
            movie_genre.innerHTML = "Coolest genre";
            // Greet User
            booth.innerHTML += '<p> Welcome !! Voting will begin when all users enter room.</p>';
            chat_history.innerHTML += '<p> Chatting </p>';
            vote_message.innerHTML = 'Vote here';
            document.getElementById('yes_button').style.visibility = 'hidden';
            document.getElementById('no_button').style.visibility = 'hidden';
        }

        let userName = prompt("What is your username?");
        let room     = prompt("Room Name");

        
        // establish socket.io connection
        const socket = io();
        reset();

        socket.emit("join room", {username : userName, roomName : room});
        socket.on('send data', (data) => {
            ID = data.id;
            console.log(" my ID:" + ID);
        });

        //button click events
        function vote_yes(){
            socket.emit("vote",1);
            vote_message.innerHTML = 'Vote of [YES] has been Recorded!!';
            console.log('Vote Sent');
        }

        function vote_no(){
            socket.emit("vote",0);
            vote_message.innerHTML = 'Vote of [NO] has been Recorded!!';
            console.log('Vote Sent');
        }

        function send_chat(){
            chat = document.getElementById("input_chat").value;
            console.log("chat:"+ chat );
            if(chat != ''){
                socket.emit("chat",chat);
                console.log('Sending Message');
            }
            document.getElementById("input_chat").value = '';
            
        }
        socket.on("vote",function(msg){
            console.log("Sent message to myself");
        })

        // watch for socket to emit a 'movie'
        socket.on("movie", function(msg){
            msg = JSON.parse(msg, reviver);
            booth.innerHTML = '';
            console.log("Movies" + msg);
            movie_name.innerHTML = msg.get('movie_name');
            movie_genre.innerHTML = "Genre: " + msg.get('genre');
            movie_year.innerHTML = "Year: " + msg.get('year');
            movie_img_url.src = msg.get('img_url');
            document.getElementById('yes_button').style.visibility = 'visible';
            document.getElementById('no_button').style.visibility = 'visible';
        });

        // watch for socket to emit a 'chat_history'
        socket.on("chat_history", function(msg){
            msg = JSON.parse(msg, reviver);
            console.log("Chat history: "+msg);
            chat_history.innerHTML = '';
            for(chat in msg){
            chat_history.innerHTML += msg[chat][0]+": "+msg[chat][1] +'<br>';
            }
        });

        // watch for socket to emit a 'vote_result'
        socket.on("vote_result", function(msg){
            console.log("Vote results " + msg);
            vote_message.innerHTML = 'Most Popular Movie:';
            document.getElementById('yes_button').style.visibility = 'hidden';
            document.getElementById('no_button').style.visibility = 'hidden';
        });

        // watch for socket to emit a 'user connected' event
        socket.on("user connected", function(msg){
            console.log("User Connected" + msg);
        });

        //JSON wrapper & unwrapper functions
        function replacer(key, value) {
        if(value instanceof Map) {
            return {
            dataType: 'Map',
            value: Array.from(value.entries()), // or with spread: value: [...value]
            };
        } else {
            return value;
        }
        }
        function reviver(key, value) {
        if(typeof value === 'object' && value !== null) {
            if (value.dataType === 'Map') {
            return new Map(value.value);
            }
        }
        return value;
        }
    </script>
</body>
</html>
